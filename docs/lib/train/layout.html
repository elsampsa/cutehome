<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CuteFront App</title>
    <link href="../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="../lib/include/bootstrap-icons/css/bootstrap-icons.min.css" rel="stylesheet">
    <link href="../lib/include/fontawesome/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
            width: 250px;
        }
        .main-content {
            margin-left: 250px; /* Adjust based on your sidebar width */
        }

        /* Mobile adjustments */
        @media (max-width: 767px) {
            .sidebar {
                width: 100%;
                padding: 0;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div id="sidebar" class="col-12 col-md-auto"></div>
            <div id="main-group" class="col-12 col-md-9 col-lg-10">
            </div>
        </div>
    </div>

    <!-- Network testing widgets (only used when networkTest = true) -->
    <div id="network-sim"></div>
    <div id="loading-indicator"></div>

    <!-- Test panel - will be populated only in development mode -->
    <div id="test-panel" style="margin-top: 2rem; padding: 1rem; border-top: 2px solid #ccc;"></div>

    <script src="../lib/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global CuteFront configuration - available to all widgets
        window.CuteFrontPath = {
            static: './static',
            assets: './assets',
            images: './static'
        };
    </script>
    <script type="module">
        // Testing utilities - centralized test mode and parameter management
        import { TestingUrlManager } from '../lib/base/testingutils.js';
        const testManager = new TestingUrlManager(window);
        const isTestMode = testManager.isTestMode();
        const useMockDataSources = testManager.useMockDataSources();
        const networkTest = testManager.getNetworkTestFlag();
        const useTestPanel = testManager.getTestPanelFlag();

        // Theme widget - instantiate early to prevent flash
        import { ThemeWidget } from '../lib/base/themewidget.js';
        const themeWidget = new ThemeWidget();

        import { ElementWidget } from '../lib/base/widget.js';
        import { StateWidget } from '../lib/base/statewidget.js';
        import { ContainerWidget } from '../lib/base/containerwidget.js';
        import { FapiGroup } from './lib/fapigroup.js';
        import { SidebarMenuItem } from '../lib/base/sidebarwidget.js';
        import { FapiSidebar } from './lib/fapisidebar.js';
        import { FapiPaginationStrategy } from './lib/fapipagination.js';
        import { LocalStorageAuthModel } from '../lib/base/authmodel.js';
        // subsections
        import { AuthUserFloaterWidget } from './lib/authuserfloater.js';
        import { DashboardSection } from './layout/sections/dashboard/main.js'
        import { ItemsSection } from './layout/sections/items/main.js'
        import { SettingsSection } from './layout/sections/settings/main.js'
        import { AdminSection } from './layout/sections/admin/main.js'
        // warning banner
        import { BannerWidget } from './lib/banner.js';
        import { LoadingIndicatorWidget } from '../lib/base/loadingindicatorwidget.js';
        // datasources
        // authenticated user
        import { AuthUserHTTPDataSource, AuthUserMockDataSource } from './datapi/authuser/datasource.js'
        import { AuthUserDataSourceWidget } from './datapi/authuser/datawidget.js'
        // items
        import { ItemMockDataSource, ItemHTTPDataSource } from './datapi/item/datasource.js';
        import { ItemDataModel } from './datapi/item/datamodel.js';
        import { ItemDataSourceWidget } from './datapi/item/datawidget.js';
        // users
        import { UserMockDataSource, UserHTTPDataSource } from './datapi/user/datasource.js';
        import { UserDataModel } from './datapi/user/datamodel.js';
        import { UserDataSourceWidget } from './datapi/user/datawidget.js';
        
        const bannerWidget = new BannerWidget();

        // datasources
        if (useMockDataSources) {
            // file:/// protocol - uses mock datasources for standalone testing
            var authUserDataSource = new AuthUserMockDataSource(); // NOTE: not using datamodel
            var itemDataSource = new ItemMockDataSource()
                .setDataModel(new ItemDataModel()).setUUIDKey("id")
                .setPaginationStrategy(new FapiPaginationStrategy())
            var userDataSource = new UserMockDataSource()
                .setDataModel(new UserDataModel()).setUUIDKey("id")
                .setPaginationStrategy(new FapiPaginationStrategy())
            bannerWidget.ok_slot("Using mock data sources (file:// mode)");
            console.log("using MOCK datasource (file:// protocol)")
        }
        else {
            // Shared auth model for all datasources
            var authModel = new LocalStorageAuthModel("access_token");

            // Auto-detect environment and configure base URL
            let baseUrl;
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Second tier: python http.server -> docker backend on port 8000
                baseUrl = 'http://localhost:8000/api/v1';
            } else {
                // Third tier: everything in docker / production - use relative URL (goes through Traefik)
                baseUrl = '/api/v1';
            }

            var authUserDataSource = new AuthUserHTTPDataSource()
                .setBaseUrl(baseUrl)
                .setAuthModel(authModel)
            var itemDataSource = new ItemHTTPDataSource()
                .setBaseUrl(baseUrl)
                .setDataModel(new ItemDataModel())
                .setUUIDKey("id")
                .setPaginationStrategy(new FapiPaginationStrategy())
                .setAuthModel(authModel)
            var userDataSource = new UserHTTPDataSource()
                .setBaseUrl(baseUrl)
                .setDataModel(new UserDataModel())
                .setUUIDKey("id")
                .setPaginationStrategy(new FapiPaginationStrategy())
                .setAuthModel(authModel)
        }

        // Create all widgets
        const authUserDataSourceWidget = new AuthUserDataSourceWidget('auth-user-datasource-widget', authUserDataSource);
        const itemDataSourceWidget = new ItemDataSourceWidget('item-datasource-widget', itemDataSource);
        const userDataSourceWidget = new UserDataSourceWidget('user-datasource-widget', userDataSource);
        itemDataSourceWidget.setLogLevel(-1); // Enable debug logging
        userDataSourceWidget.setLogLevel(-1); // Enable debug logging

        // Create loading indicator widget (overlay)
        const loadingIndicator = new LoadingIndicatorWidget('loading-indicator');
        loadingIndicator.setLogLevel(-1);

        // Network testing widgets
        if (networkTest) {
            const { NetworkSimulatorWidget } = await import('../lib/base/networksimulatorwidget.js');
            
            // Create network simulator widget (floating panel in bottom-right)
            const networkSimWidget = new NetworkSimulatorWidget('network-sim');
            networkSimWidget.setLogLevel(-1);

            // Wire network simulator to all datasource widgets
            networkSimWidget.signals.simulator_changed.connect(
                (sim) => authUserDataSourceWidget.set_network_simulator_slot(sim)
            );
            networkSimWidget.signals.simulator_changed.connect(
                (sim) => itemDataSourceWidget.set_network_simulator_slot(sim)
            );
            networkSimWidget.signals.simulator_changed.connect(
                (sim) => userDataSourceWidget.set_network_simulator_slot(sim)
            );
        }

        const authUserFloaterWidget = new AuthUserFloaterWidget("userFloater");
        // sections
        const dashboardSection = new DashboardSection();
        const itemsSection = new ItemsSection();
        const settingsSection = new SettingsSection();
        const adminSection = new AdminSection();
        const sections = [dashboardSection, itemsSection, settingsSection, adminSection]
        // Set debug level for all widgets
        sections.forEach(w => w.setLogLevel(-1));

        const container = new ContainerWidget("main-group")
        container.setLogLevel(-1);
        container.setItems({
            dashboardSection: dashboardSection,
            itemsSection: itemsSection,
            settingsSection: settingsSection,
            adminSection: adminSection,
        })
        
        // Define sidebarwidget with programmatic item creation
        const fapiSidebar = new FapiSidebar("sidebar").createItems();

        // Clicking sidebar widget's menu elements reveals different sections from container
        fapiSidebar.widgets.dashboardItem.signals.clicked.connect((id)=>container.show_slot(container.widgets.dashboardSection));
        fapiSidebar.widgets.itemsItem.signals.clicked.connect((id)=>container.show_slot(container.widgets.itemsSection));
        fapiSidebar.widgets.userSettingsItem.signals.clicked.connect((id)=>container.show_slot(container.widgets.settingsSection));
        fapiSidebar.widgets.adminItem.signals.clicked.connect((id)=>container.show_slot(container.widgets.adminSection));

        container.show_slot(dashboardSection);

        /* Connect data flow between the data source and the
        items section.  Take a look into section.js:ItemSection how
        the API for this is declared
        */
        // connect datamodel schema to items section
        itemDataSourceWidget.signals.datamodel_create.connect((schema)=> 
            container.widgets.itemsSection.datamodel_slot(schema)
        );
        // connect signal that carries actual data
        itemDataSourceWidget.signals.data.connect((datums)=> 
            container.widgets.itemsSection.widgets.itemList.datums_slot(datums)
        );
        // connect signal that carries pagination info
        itemDataSourceWidget.signals.pagination_changed.connect((paginationInfo)=> 
            container.widgets.itemsSection.widgets.itemList.set_pagination_slot(paginationInfo)
        );
        // connect error signals to warning
        itemDataSourceWidget.signals.error.connect((message) =>
            bannerWidget.error_slot(message)
        );
        // ui release/blocking for datasource network operations
        itemDataSourceWidget.signals.loading_start.connect(
            (op) => loadingIndicator.loading_start_slot(op)
        );
        itemDataSourceWidget.signals.loading_success.connect(
            (op) => loadingIndicator.loading_success_slot(op)
        );
        itemDataSourceWidget.signals.loading_error.connect(
            (data) => loadingIndicator.loading_error_slot(data)
        );

        // connect signal that carries user's pagination request to data source
        container.widgets.itemsSection.signals.page_changed.connect(
            (pageNumber) =>
            itemDataSourceWidget.set_page_slot(pageNumber)
        );
        // connect "create" request to data source
        container.widgets.itemsSection.signals.create.connect(
            (datum) =>
            itemDataSourceWidget.create_slot(datum)
        );
        // connect "update" request to datasource
        container.widgets.itemsSection.signals.update.connect(
            (datum) =>
            itemDataSourceWidget.update_slot(datum)
        );
        // connect "delete" request to datasource
        container.widgets.itemsSection.signals.delete_datum.connect(
            (datum) =>
            itemDataSourceWidget.delete_slot(datum)
        )
        
        // users
        userDataSourceWidget.signals.datamodel_create.connect((schema)=>
            container.widgets.adminSection.datamodel_slot(schema)
        );
        userDataSourceWidget.signals.data.connect((datums)=>
            container.widgets.adminSection.widgets.userList.datums_slot(datums)
        );
        // connect signal that carries pagination info
        userDataSourceWidget.signals.pagination_changed.connect((paginationInfo)=>
            container.widgets.adminSection.widgets.userList.set_pagination_slot(paginationInfo)
        );
        // connect error signals to warning
        userDataSourceWidget.signals.error.connect((message) =>
            bannerWidget.error_slot(message)
        );
        // ui release/blocking for datasource network operations
        userDataSourceWidget.signals.loading_start.connect(
            (op) => loadingIndicator.loading_start_slot(op)
        );
        userDataSourceWidget.signals.loading_success.connect(
            (op) => loadingIndicator.loading_success_slot(op)
        );
        userDataSourceWidget.signals.loading_error.connect(
            (data) => loadingIndicator.loading_error_slot(data)
        );
        // connect signal that carries pagination request to data source
        container.widgets.adminSection.signals.page_changed.connect(
            (pageNumber) =>
            userDataSourceWidget.set_page_slot(pageNumber)
        );
        // connect "create" request to data source
        container.widgets.adminSection.signals.create.connect(
            (datum) =>
            userDataSourceWidget.create_slot(datum)
        );
        // connect "update" request to datasource
        container.widgets.adminSection.signals.update.connect(
            (datum) =>
            userDataSourceWidget.update_slot(datum)
        );
        // connect "delete" request to datasource
        container.widgets.adminSection.signals.delete.connect(
            (datum) =>
            userDataSourceWidget.delete_slot(datum)
        )

        // Theme connections
        // AppearanceWidget -> ThemeWidget (user selects theme)
        container.widgets.settingsSection.widgets.tab.widgets.appearance.signals.modeChanged.connect(
            (mode) => themeWidget.set_theme_slot(mode)
        );
        // Initialize AppearanceWidget with current theme from ThemeWidget
        container.widgets.settingsSection.widgets.tab.widgets.appearance.set_mode_slot(themeWidget.getMode());

        // change user data --> authUserDataSource
        container.widgets.settingsSection.signals.update_user_data.connect((datum) =>
            authUserDataSourceWidget.updateMe_slot(datum)
        );
        container.widgets.settingsSection.signals.password_changed.connect((data) =>
            authUserDataSourceWidget.updatePassword_slot(data)
        );
        authUserDataSourceWidget.signals.me.connect((datum) =>
            container.widgets.settingsSection.set_datum_slot(datum)
        );
        
        // connections from authUserDataSource to GUI widgets
        authUserDataSourceWidget.signals.me.connect((datum) => {
            fapiSidebar.setAuthUser_slot(datum);
            container.widgets.dashboardSection.set_user_slot(datum);
            // container.widgets.settingsSection.widgets.tab.widgets.authUserInfo.set_datum_slot(datum); // not used..
            container.widgets.adminSection.widgets.userList.set_current_user_slot(datum);
        })
        // success/error msgs
        authUserDataSourceWidget.signals.message.connect((msg) => {
            bannerWidget.ok_slot(msg)
        })
        authUserDataSourceWidget.signals.error.connect((msg) => {
            bannerWidget.error_slot(msg)
        })
        // data operations un/block UI
        authUserDataSourceWidget.signals.loading_start.connect(
            (op) => loadingIndicator.loading_start_slot(op)
        );
        authUserDataSourceWidget.signals.loading_success.connect(
            (op) => loadingIndicator.loading_success_slot(op)
        );
        authUserDataSourceWidget.signals.loading_error.connect(
            (data) => loadingIndicator.loading_error_slot(data)
        );
        // connections from floating widget for user shortcuts
        authUserFloaterWidget.signals.profile.connect(() =>
            fapiSidebar.widgets.userSettingsItem.clicked_slot()
        )
        authUserFloaterWidget.signals.logout.connect(() => {
            if (authModel) authModel.clear(); // clear token from localStorage
            // Preserve only testing parameters and prevent back navigation
            const params = testManager.getTestingParams();
            window.location.replace("landing.html" + params);
        })

        // Centralized 401 Unauthorized handler for all datasource widgets
        const handle401Error = (error) => {
            if (error.status === 401) {
                const userConfirmed = confirm(
                    "Your session has expired or you are not authorized.\n\n" +
                    "Would you like to return to the login page?"
                );
                if (userConfirmed) {
                    if (authModel) authModel.clear(); // clear token from localStorage
                    const params = testManager.getTestingParams();
                    window.location.replace("landing.html" + params);
                }
            }
        };
        // Connect 401 handler to all datasource widgets
        authUserDataSourceWidget.signals.error.connect(handle401Error);
        itemDataSourceWidget.signals.error.connect(handle401Error);
        userDataSourceWidget.signals.error.connect(handle401Error);
        
        authUserDataSourceWidget.signals.me.connect((user) => {
            if (user.is_superuser) {
                userDataSourceWidget.model_slot() // propagate datamodel
                userDataSourceWidget.read_slot() // send data
            }
            else {
                console.log("superuser disabled!")
                userDataSourceWidget.disable_slot()
            }
        })

        authUserDataSourceWidget.me_slot() // propagate info of current user (must be before userDataSourceWidget.read_slot)
        itemDataSourceWidget.model_slot() // propagate datamodel
        itemDataSourceWidget.read_slot() // send data

        // Configure serialization
        fapiSidebar.setSerializationKey("nav").setSerializationWrite(true);
        // Create StateWidget and register
        const stateWidget = new StateWidget();
        stateWidget.setLogLevel(-1);
        stateWidget.register(fapiSidebar);

        window.genDocs = ["fapiSidebar", "container", "authUserDataSourceWidget", "itemDataSourceWidget","userDataSourceWidget","authUserFloaterWidget", "bannerWidget"]

        // ============================================================================
        // TEST MODE - Activate debug features
        // ============================================================================

        if (isTestMode) {
            console.log("ðŸ§ª Test mode enabled - activating debug features");
            container.activate_debug_slot();
        }

        // ============================================================================
        // TEST PANEL - Only active when test-panel parameter is set
        // ============================================================================

        if (useTestPanel) {
            console.log("ðŸ§ª Test panel enabled - injecting test panel");

            const testPanel = document.getElementById('test-panel');
            testPanel.innerHTML = `
                <button id="test-panel-toggle" class="btn btn-sm btn-outline-secondary">
                    Show Test Panel
                </button>
                <div id="test-panel-content" style="display: none;">
                    <h3>ðŸ§ª Test Panel (Development Mode Only)</h3>
                    <p style="color: #666; font-size: 0.9em;">
                        Test user role switching and sidebar visibility.
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
                        <button id="test-set-superuser" class="btn btn-primary">
                            Switch to Admin User
                        </button>
                        <button id="test-set-normaluser" class="btn btn-secondary">
                            Switch to Normal User
                        </button>
                    </div>
                    <div id="test-results" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 0.85em;">
                        Current role: <span id="role-text">-</span>
                    </div>
                </div>
            `;

            const testResults = document.getElementById('test-results');
            const roleText = document.getElementById('role-text');
            const testPanelContent = document.getElementById('test-panel-content');
            const testPanelToggle = document.getElementById('test-panel-toggle');

            // Toggle collapse/expand
            testPanelToggle.onclick = () => {
                if (testPanelContent.style.display === 'none') {
                    testPanelContent.style.display = '';
                    testPanelToggle.textContent = 'Hide Test Panel';
                } else {
                    testPanelContent.style.display = 'none';
                    testPanelToggle.textContent = 'Show Test Panel';
                }
            };

            // Update role display whenever user data changes
            authUserDataSourceWidget.signals.me.connect((datum) => {
                const roleInfo = datum.is_superuser ?
                    'ðŸ‘‘ Admin (is_superuser: true)' :
                    'ðŸ‘¤ Normal User (is_superuser: false)';
                roleText.textContent = roleInfo;
                console.log("User role updated:", roleInfo);
            });

            // Switch to superuser
            document.getElementById('test-set-superuser').onclick = () => {
                console.log("ðŸ§ª Switching to superuser...");
                authUserDataSource.setSuperUser();
                authUserDataSourceWidget.me_slot();
            };

            // Switch to normal user
            document.getElementById('test-set-normaluser').onclick = () => {
                console.log("ðŸ§ª Switching to normal user...");
                authUserDataSource.setNormalUser();
                authUserDataSourceWidget.me_slot();
            };
        }
    </script>
</body>
</html>
